{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container vh-90">
    <div class="row">
        <div class="col">
            <h2>Your Cart</h2>
            <hr>
            {% if cart_items %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Subtotal</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in cart_items %}
                    <tr>
                        <td>{{ item.product.name }}</td>
                        <td>{{ item.product.price }}</td>
                        <td>
                            <form action="{% url 'update_cart' item.item_key %}" method="post">
                                {% csrf_token %}
                                <input type="number" name="quantity" value="{{ item.quantity }}">
                                <button type="submit">Update</button>
                            </form>
                        </td>
                        <td>{{ item.subtotal }}</td>
                        <td>
                            <a href="{% url 'remove_from_cart' item.item_key %}">Remove</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="row">
                <div class="col-md-6 offset-md-6">
                    <table class="table">
                        <tbody>
                            <tr>
                                <td><strong>Bag Total:</strong></td>
                                <td>£{{ total }}</td>
                            </tr>
                            <tr>
                                <td><strong>Delivery:</strong></td>
                                <td>£{{ delivery }}</td>
                            </tr>
                            <tr>
                                <td><strong>Grand Total:</strong></td>
                                <td>£{{ grand_total }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <a href="{% url 'checkout' %}" class="btn btn-primary">Proceed to Checkout</a>
                </div>
            </div>
            {% else %}
            <p>Your cart is empty.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}



{% block extra_js %}
<script>
$(document).ready(function () {
    // Initialize bag total variable outside of the function
    var bagTotal = 0;

    // Function to update bag total and grand total
    function updateTotals() {
        // Reset bag total to zero before recalculating
        bagTotal = 0;

        $('.input-group').each(function () {
            var itemId = $(this).find('input[type="number"]').attr('id'); // Get item ID
            if (itemId) {
                itemId = itemId.toString(); // Convert itemId to string
                var itemKeyParts = itemId.split('_');
                var productId = itemKeyParts[1]; // Extract product ID from itemId
                var sizeId = itemKeyParts[2]; // Extract size ID from itemId (if applicable)
                var quantity = parseInt($(this).find('input[type="number"]').val());
                var productPriceText = $('#price_' + productId + (sizeId ? '_' + sizeId : '')).text().replace('£', ''); // Construct correct selector for product price
                var productPrice = parseFloat(productPriceText);
                var subtotal = productPrice * quantity;

                // Log values
                console.log('Item ID:', itemId);
                console.log('Quantity:', quantity);
                console.log('Product Price:', productPrice);
                console.log('Subtotal:', subtotal);

                // Update subtotal in HTML
                var subtotalElement = $('#subtotal_' + itemId); // Updated here
                if (subtotalElement.length > 0) {
                    subtotalElement.text('£' + subtotal.toFixed(2));
                } else {
                    console.error('Subtotal element not found for item ID:', itemId);
                }

                bagTotal += subtotal;
            } else {
                console.error('Item ID not found for input-group:', $(this));
            }
        });

        // Log bag total before updating HTML
        console.log('Calculated Bag Total:', bagTotal);

        // Update bag total in HTML
        $('#bag-total').text('£' + bagTotal.toFixed(2));

        // Update grand total
        var delivery = 3.99; // Assuming delivery cost is fixed
        var grandTotal = bagTotal + delivery;

        // Log grand total
        console.log('Grand Total:', grandTotal);

        // Update grand total in HTML
        $('#grand-total').text('£' + grandTotal.toFixed(2));
    }

    // Function to handle quantity adjustment
    $('.btn-quantity').click(function () {
        var action = $(this).data('action');
        var itemId = $(this).data('item-id');
        var quantityField = $(this).closest('.input-group').find('input[type="number"]');
        var currentQuantity = parseInt(quantityField.val());

        console.log('Action:', action);
        console.log('Item ID:', itemId);
        console.log('Current Quantity:', currentQuantity);

        if (action === 'increase') {
            quantityField.val(currentQuantity + 1);
        } else if (action === 'decrease' && currentQuantity > 1) {
            quantityField.val(currentQuantity - 1);
        }

        updateTotals();
    });

    // Call updateTotals initially
    updateTotals();
});

</script>
{% endblock %}
